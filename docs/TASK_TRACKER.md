# Zino's Chat 任务跟踪表

## 📌 当前任务主线

**目标**：优化 Zino's Chat 的语音、检索和智能化能力

**开始日期**：2025-10-06  
**预计完成**：2025-10-20（14 工作日）

---

## 🎯 核心需求（优化后）

### 需求 1：自然语音合成升级
**原表述**：语音生成效果很生硬，需要更自然的 TTS 模型  
**优化表述**：
> 将当前的 gTTS 语音引擎替换为 OpenAI TTS（nova 语音），实现情感化、自然化的语音输出。要求保持现有音频处理流程（Base64 + HTML5），代码改动 < 50 行，单次调用延迟 < 2 秒，语音自然度提升 60%+。

**技术方案**：OpenAI TTS API (`tts-1` 模型)  
**预估成本**：$7.5/月（10K 对话）  
**改动范围**：`main.py` 第 169-233 行

---

### 需求 2：RAG 检索多样性增强
**原表述**：RAG 系统检索重复，需要更先进的方案  
**优化表述**：
> 优化当前 ChromaDB + MMR 检索策略，解决重复检索问题。实施方案包括：(1) 调整 MMR 参数（lambda_mult 从 1.0 改为 0.5）；(2) 引入对话历史去重；(3) 集成重排序机制（Cohere Rerank）；(4) 实现混合检索（向量 + BM25）。要求连续 5 轮对话无完全重复结果，相关性提升 40%+，延迟增加 < 500ms。

**技术方案**：
- 阶段一：MMR 参数调优 + 历史去重
- 阶段二：Cohere Rerank + 混合检索

**预估成本**：$0-20/月  
**改动范围**：`main.py` 第 762-766 行 + 新增 `advanced_retrieval.py`

---

### 需求 3：智能体实时知识增强
**原表述**：基于用户问题同步查询资料并整合 RAG 结果  
**优化表述**：
> 新增智能路由层，自动判断用户问题是否需要外部实时信息（如"最新研究"、"当前保护状况"）。需要时调用 Tavily 搜索 API 获取实时资料，并与 RAG 知识库结果智能融合。UI 需明确标注信息来源（🔖 知识库 vs 🌐 实时搜索）。要求路由准确率 > 85%，超范围问题准确率从 30% 提升到 75%+。

**技术方案**：LangChain Tools + Tavily API  
**预估成本**：$10/月  
**改动范围**：`main.py` 第 760-780 行 + 新增 `agent.py` + UI 更新

---

## 📋 任务清单

### ✅ 已完成
- [x] 项目结构分析
- [x] 优化需求调研
- [x] 技术方案对比
- [x] 详细计划制定

---

### 🔄 进行中

#### 阶段一：TTS 升级（2-3 天）
- [ ] **任务 1.1**：测试 OpenAI TTS API  
  - 创建测试脚本 `test_tts.py`
  - 对比 nova/alloy/shimmer 三种语音
  - 验证延迟和音质
  
- [ ] **任务 1.2**：开发新 TTS 函数  
  - 编写 `speak_text_v2(text)` 函数
  - 实现错误处理和重试机制
  - 保留 gTTS 作为 fallback
  
- [ ] **任务 1.3**：集成到主流程  
  - 修改 `main.py` 第 776 行调用
  - 添加配置开关 `USE_NEW_TTS`
  - 更新音频文件清理逻辑
  
- [ ] **任务 1.4**：用户测试  
  - A/B 测试（5 人使用旧版，5 人使用新版）
  - 收集自然度评分
  - 分析延迟数据

**上下文信息**：
- OpenAI API key 已配置在 `st.secrets["OPENAI_API_KEY"]`
- 当前音频处理流程：gTTS → pydub 加速 → Base64 → HTML5
- 目标：保持 Base64 + HTML5 流程不变

---

#### 阶段二：RAG 优化（4-5 天）

**子任务 2A：快速改进（1-2 天）**
- [ ] **任务 2.1**：调整 MMR 参数  
  - 修改第 763 行：`lambda_mult=0.5, k=4, fetch_k=20`
  - 对比前后检索结果差异
  - 记录性能变化
  
- [ ] **任务 2.2**：实现历史去重  
  - 在 `session_state` 中存储 `retrieved_doc_ids`
  - 编写 `deduplicate_with_history()` 函数
  - 测试连续 10 轮对话的去重效果

**子任务 2B：深度优化（2-3 天）**
- [ ] **任务 2.3**：集成 Cohere Rerank  
  - 注册 Cohere API（免费额度 1000 次/月）
  - 安装 `cohere` 包
  - 创建 `ContextualCompressionRetriever`
  - 对比重排序前后的相关性
  
- [ ] **任务 2.4**：实现混合检索  
  - 加载所有文档用于 BM25 索引
  - 创建 `EnsembleRetriever`（0.6 向量 + 0.4 BM25）
  - 测试关键词敏感问题（如"海拔"、"繁殖季节"）
  
- [ ] **任务 2.5**：性能调优  
  - 添加检索时间日志
  - 优化 fetch_k 和权重参数
  - 确保总延迟 < 3 秒

**上下文信息**：
- 当前向量库路径：`db5/`（ChromaDB）
- 检索函数位置：`main.py` 第 762 行
- 需要在每次检索后更新 `session_state.retrieved_doc_ids`

**知识图谱关系**：
```
检索优化 → MMR参数调整 → lambda_mult(多样性控制)
检索优化 → 历史去重 → session_state(状态管理)
检索优化 → 重排序 → Cohere API(外部服务)
检索优化 → 混合检索 → BM25+向量(技术融合)
```

---

#### 阶段三：智能体集成（5-7 天）

**子任务 3A：基础设施（2 天）**
- [ ] **任务 3.1**：API 准备  
  - 注册 Tavily API：https://tavily.com/
  - 配置到 `.streamlit/secrets.toml`
  - 测试搜索功能（`tavily.search("Zino's Petrel conservation 2025")`）
  
- [ ] **任务 3.2**：智能路由开发  
  - 创建 `agent.py` 模块
  - 实现 `should_search_web(query)` 函数
  - 定义判断规则（关键词：latest, current, recent, 2024, 2025 等）
  - 使用 LLM 辅助判断（temperature=0 保证稳定性）

**子任务 3B：结果融合（2 天）**
- [ ] **任务 3.3**：工具链集成  
  - 定义 LangChain Tool：knowledge_base + web_search
  - 实现 `enhanced_query(user_input)` 函数
  - 处理并发调用（RAG 和搜索同时执行）
  
- [ ] **任务 3.4**：智能融合逻辑  
  - 编写 `merge_sources(rag_docs, web_results)` 函数
  - 设计提示词：优先内部知识，补充外部动态
  - 添加来源标注逻辑

**子任务 3C：UI 改造（1-2 天）**
- [ ] **任务 3.5**：来源标签设计  
  - 在回复下方添加来源标签组件
  - 样式：`🔖 知识库` / `🌐 实时搜索` 徽章
  - 颜色区分：绿色（内部）/ 蓝色（外部）
  
- [ ] **任务 3.6**：事实核查更新  
  - 修改右侧 Expander（第 908-929 行）
  - 分别展示内部文档和外部链接
  - 添加"查看搜索源"按钮

**子任务 3D：测试与优化（1 天）**
- [ ] **任务 3.7**：端到端测试  
  - 测试纯 RAG 场景（"你吃什么？"）
  - 测试混合场景（"最新的保护进展？"）
  - 测试边缘情况（API 失败、超时）
  - 验证路由准确率（100 个测试问题）

**上下文信息**：
- 核心查询流程：`main.py` 第 732-803 行
- 当前仅使用 `vectordb.max_marginal_relevance_search()`
- 需要保留原有流程作为默认路径

**知识图谱关系**：
```
智能体系统 → 路由器(判断层) → LLM分类 → 实时搜索需求识别
智能体系统 → 搜索工具(执行层) → Tavily API → 外部知识获取
智能体系统 → 融合器(整合层) → 提示词工程 → 多源信息合成
智能体系统 → UI展示(呈现层) → 来源标签 → 用户信任建立
融合器 → RAG结果(内部) + 搜索结果(外部) → 最终回答
```

---

### ⏳ 待开始

#### 阶段四：集成测试（3 天）
- [ ] **任务 4.1**：功能回归测试
- [ ] **任务 4.2**：性能压测
- [ ] **任务 4.3**：成本分析
- [ ] **任务 4.4**：用户验收测试
- [ ] **任务 4.5**：文档更新
- [ ] **任务 4.6**：生产部署

---

## 🔗 上下文关联

### 主线任务流程
```
TTS升级(独立) ─┐
               ├─→ 集成测试 → 部署上线
RAG优化 ──────┤
               │
智能体集成 ────┘
```

### 技术依赖关系
```
OpenAI API ← TTS升级
              ↓
         主应用(main.py)
              ↓
ChromaDB ← RAG优化 → Cohere API
              ↓
         检索结果
              ↓
智能体系统 ← Tavily API
              ↓
         融合回答 → UI展示
```

### 代码改动范围
```
main.py (核心)
├── speak_text_v2() [169-233行]      # TTS升级
├── advanced_retrieval() [762-766行]  # RAG优化
└── enhanced_query() [760-803行]      # 智能体集成

新增文件
├── agent.py                          # 智能体逻辑
├── advanced_retrieval.py             # 高级检索
└── test_tts.py                       # TTS测试脚本
```

---

## 📊 进度追踪

| 阶段 | 状态 | 进度 | 预计完成 | 实际完成 |
|------|------|------|---------|---------|
| 需求分析 | ✅ | 100% | 2025-10-06 | 2025-10-06 |
| TTS升级 | ⏸️ | 0% | 2025-10-09 | - |
| RAG优化-快速 | ⏸️ | 0% | 2025-10-11 | - |
| RAG优化-深度 | ⏸️ | 0% | 2025-10-14 | - |
| 智能体-基础 | ⏸️ | 0% | 2025-10-16 | - |
| 智能体-融合 | ⏸️ | 0% | 2025-10-18 | - |
| 集成测试 | ⏸️ | 0% | 2025-10-20 | - |

**总体进度**：7% (1/14 天)

---

## 💡 关键决策记录

### 决策 1：选择 OpenAI TTS 而非 ElevenLabs
**日期**：2025-10-06  
**理由**：
- 已有 OpenAI API，无需额外认证
- 成本更低（$15/1M 字符 vs $22-99/月）
- 集成更简单（官方 SDK 支持）
- 性能足够（自然度 4.5/5）

### 决策 2：分阶段实施 RAG 优化
**日期**：2025-10-06  
**理由**：
- 快速改进（MMR 参数）可立即见效
- 深度优化（重排序）需要评估成本
- 降低一次性改动风险

### 决策 3：使用 Tavily 而非 DuckDuckGo
**日期**：2025-10-06  
**理由**：
- Tavily 专为 AI 设计，结构化输出
- 返回摘要而非原始 HTML
- 免费额度 1000 次/月足够初期使用
- DuckDuckGo 作为备用方案

---

## 🚨 风险与阻塞

### 当前风险
1. **OpenAI TTS 延迟不确定**（风险等级：中）
   - 缓解：使用 `tts-1` 快速模型
   - 监控：记录每次调用延迟

2. **Cohere API 免费额度限制**（风险等级：低）
   - 缓解：仅在检索结果 > 5 时启用
   - 备选：FlashRank 开源方案

3. **智能路由误判率**（风险等级：中）
   - 缓解：保守策略，优先 RAG
   - 验证：前 500 次人工审核

### 阻塞项
- 无当前阻塞

---

## 📈 成功指标追踪

| 指标 | 基线 | 目标 | 当前值 | 状态 |
|------|------|------|--------|------|
| 语音自然度 | 2.5/5 | 4.0/5 | - | 🟡 待测 |
| 检索重复率 | 30% | < 5% | - | 🟡 待测 |
| 超范围准确率 | 30% | 75% | - | 🟡 待测 |
| 平均响应时间 | 2.1s | < 3s | - | 🟡 待测 |
| 月度成本 | $5 | < $40 | - | 🟡 待测 |

---

## 🔄 每日更新记录

### 2025-10-06（Day 1）
- ✅ 完成项目结构分析
- ✅ 完成技术调研和方案对比
- ✅ 制定详细优化计划
- ✅ 创建任务跟踪文档
- 📝 明日计划：开始 TTS 升级测试

---

## 📞 协作信息

**开发者**：AI 开发团队  
**项目路径**：`E:\ProjectFolder\Business_Data_Analyse\Musement\zinos-chat`  
**文档位置**：
- 项目文档：`PROJECT_DOCUMENTATION.md`
- 优化计划：`OPTIMIZATION_PLAN.md`
- 任务追踪：`TASK_TRACKER.md`（本文档）

**沟通原则**：
- 每完成一个任务，立即更新本文档
- 遇到阻塞，及时记录并寻求帮助
- 每日结束前，更新进度和明日计划

---

**最后更新**：2025-10-06 18:30  
**下次审查**：2025-10-07 09:00


